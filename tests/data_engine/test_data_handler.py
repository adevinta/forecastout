import numpy as np
from forecastout.data_engine.data_handler import DataHandler
import pandas as pd

THREE_MONTH_HORIZON = 3
ONE_MONTH_HORIZON = 1


def test_data_handler():
    # -- Test monthly
    pd.testing.assert_frame_equal(
        DataHandler(
            df=input_df_monthly(),
            horizon=THREE_MONTH_HORIZON,
            sum_aggregation=True
        ).df_monthly,
        expected_df_monthly_from_monthly()
    )
    # -- Test daily
    pd.testing.assert_frame_equal(
        DataHandler(
            df=input_df_daily(),
            horizon=ONE_MONTH_HORIZON,
            sum_aggregation=True
        ).df_daily,
        expected_df_daily_from_daily()
    )
    pd.testing.assert_frame_equal(
        DataHandler(
            df=input_df_daily(),
            horizon=ONE_MONTH_HORIZON,
            sum_aggregation=True
        ).df_monthly,
        expected_df_monthly_from_daily()
    )


def input_df_monthly():
    date_list = [
        "2021-01-01",
        "2021-02-01",
        "2021-03-01",
        "2021-04-01",
        "2021-05-01",
        "2021-06-01",
        "2021-07-01",
        "2021-08-01",
        "2021-10-01",
        "2021-11-01",
        "2021-12-01"
    ]
    value_list = [
        5.830303e+06,
        7.400458e+06,
        7.449702e+06,
        6.480788e+06,
        6.995587e+06,
        1.675807e+06,
        8.372645e+06,
        1.132437e+07,
        4.509435e+06,
        1.331609e+07,
        1.282667e+07
    ]
    return pd.DataFrame({'date': date_list, 'value': value_list})


def expected_df_monthly_from_monthly():
    date_list = [
        "2021-01-01",
        "2021-02-01",
        "2021-03-01",
        "2021-04-01",
        "2021-05-01",
        "2021-06-01",
        "2021-07-01",
        "2021-08-01",
        "2021-09-01",  # -- Date to check
        "2021-10-01",
        "2021-11-01",
        "2021-12-01",
        "2022-01-01",
        "2022-02-01",
        "2022-03-01"
    ]
    value_list = [
        5.830303e+06,
        7.400458e+06,
        7.449702e+06,
        6.480788e+06,
        6.995587e+06,
        1.675807e+06,
        8.372645e+06,
        1.132437e+07,
        0,  # -- Value to check
        4.509435e+06,
        1.331609e+07,
        1.282667e+07,
        np.nan,
        np.nan,
        np.nan
    ]
    return pd.DataFrame(
        {'date': pd.to_datetime(date_list), 'value': value_list}
    )


def input_df_daily():
    date_list = [
        "2021-01-01",
        "2021-01-02",
        "2021-01-03",
        "2021-01-04",
        "2021-01-05",
        "2021-01-06",
        "2021-01-07",
        "2021-01-08",
        "2021-01-09",
        "2021-01-10",
        "2021-01-11",
        "2021-01-12",
        "2021-01-13",
        "2021-01-14",
        "2021-01-15",
        "2021-01-16",
        "2021-01-17",
        "2021-01-18",
        "2021-01-19",
        "2021-01-20",
        "2021-01-21",
        "2021-01-22",
        "2021-01-23",
        "2021-01-24",
        "2021-01-25",
        "2021-01-26",
        "2021-01-27",
        "2021-01-28",
        "2021-01-29",
        "2021-01-30",
        "2021-01-31",
        "2021-02-01",
        "2021-02-02",
        "2021-02-03",
        "2021-02-04",
        "2021-02-05",
        "2021-02-06",
        "2021-02-07",
        "2021-02-08",
        "2021-02-09",
        "2021-02-10",
        "2021-02-11",
        "2021-02-12",
        "2021-02-13",
        "2021-02-14",
        "2021-02-15",
        "2021-02-16",
        "2021-02-17",
        "2021-02-18",
        "2021-02-19",
        "2021-02-20",
        "2021-02-21",
        "2021-02-22",
        "2021-02-23",
        "2021-02-24",
        "2021-02-25",
        "2021-02-26",
        "2021-02-27",
        "2021-02-28"
    ]
    value_list = [
        24345.1108,
        31643.93512,
        37702.74413,
        63790.15493,
        49700.0231,
        42981.96545,
        59259.1285,
        56119.84923,
        43468.55374,
        45174.22881,
        69707.69637,
        62419.33631,
        63633.19097,
        60598.55433,
        56480.86634,
        46518.88677,
        45399.21049,
        69707.69637,
        66777.70238,
        67609.61138,
        49977.32611,
        53890.96094,
        41815.19998,
        43442.39308,
        66610.27415,
        61890.89097,
        59798.03811,
        56768.63361,
        49427.95223,
        44258.60569,
        41846.59278,
        68080.50328,
        62848.37115,
        68561.85943,
        59996.85913,
        55267.01169,
        52284.69638,
        51735.3225,
        68007.25343,
        64329.06454,
        62769.88916,
        53958.97866,
        52923.01649,
        48135.6156,
        44133.03452,
        68860.09096,
        62121.10478,
        62769.88916,
        59714.324,
        48852.4177,
        52854.99878,
        50537.16424,
        71722.06724,
        61582.19517,
        63334.95943,
        55361.19007,
        49694.79097,
        48125.15133,
        47214.76034
        ]
    return pd.DataFrame({'date': date_list, 'value': value_list})


def expected_df_daily_from_daily():
    date_list = [
        "2021-01-01",
        "2021-01-02",
        "2021-01-03",
        "2021-01-04",
        "2021-01-05",
        "2021-01-06",
        "2021-01-07",
        "2021-01-08",
        "2021-01-09",
        "2021-01-10",
        "2021-01-11",
        "2021-01-12",
        "2021-01-13",
        "2021-01-14",
        "2021-01-15",
        "2021-01-16",
        "2021-01-17",
        "2021-01-18",
        "2021-01-19",
        "2021-01-20",
        "2021-01-21",
        "2021-01-22",
        "2021-01-23",
        "2021-01-24",
        "2021-01-25",
        "2021-01-26",
        "2021-01-27",
        "2021-01-28",
        "2021-01-29",
        "2021-01-30",
        "2021-01-31",
        "2021-02-01",
        "2021-02-02",
        "2021-02-03",
        "2021-02-04",
        "2021-02-05",
        "2021-02-06",
        "2021-02-07",
        "2021-02-08",
        "2021-02-09",
        "2021-02-10",
        "2021-02-11",
        "2021-02-12",
        "2021-02-13",
        "2021-02-14",
        "2021-02-15",
        "2021-02-16",
        "2021-02-17",
        "2021-02-18",
        "2021-02-19",
        "2021-02-20",
        "2021-02-21",
        "2021-02-22",
        "2021-02-23",
        "2021-02-24",
        "2021-02-25",
        "2021-02-26",
        "2021-02-27",
        "2021-02-28",
        "2021-03-01",
        "2021-03-02",
        "2021-03-03",
        "2021-03-04",
        "2021-03-05",
        "2021-03-06",
        "2021-03-07",
        "2021-03-08",
        "2021-03-09",
        "2021-03-10",
        "2021-03-11",
        "2021-03-12",
        "2021-03-13",
        "2021-03-14",
        "2021-03-15",
        "2021-03-16",
        "2021-03-17",
        "2021-03-18",
        "2021-03-19",
        "2021-03-20",
        "2021-03-21",
        "2021-03-22",
        "2021-03-23",
        "2021-03-24",
        "2021-03-25",
        "2021-03-26",
        "2021-03-27",
        "2021-03-28",
        "2021-03-29",
        "2021-03-30",
        "2021-03-31"
    ]
    value_list = [
        24345.1108,
        31643.93512,
        37702.74413,
        63790.15493,
        49700.0231,
        42981.96545,
        59259.1285,
        56119.84923,
        43468.55374,
        45174.22881,
        69707.69637,
        62419.33631,
        63633.19097,
        60598.55433,
        56480.86634,
        46518.88677,
        45399.21049,
        69707.69637,
        66777.70238,
        67609.61138,
        49977.32611,
        53890.96094,
        41815.19998,
        43442.39308,
        66610.27415,
        61890.89097,
        59798.03811,
        56768.63361,
        49427.95223,
        44258.60569,
        41846.59278,
        68080.50328,
        62848.37115,
        68561.85943,
        59996.85913,
        55267.01169,
        52284.69638,
        51735.3225,
        68007.25343,
        64329.06454,
        62769.88916,
        53958.97866,
        52923.01649,
        48135.6156,
        44133.03452,
        68860.09096,
        62121.10478,
        62769.88916,
        59714.324,
        48852.4177,
        52854.99878,
        50537.16424,
        71722.06724,
        61582.19517,
        63334.95943,
        55361.19007,
        49694.79097,
        48125.15133,
        47214.76034,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan,
        np.nan
    ]
    return pd.DataFrame(
        {'date': pd.to_datetime(date_list), 'value': value_list}
    )


def expected_df_monthly_from_daily():
    date_list = [
        "2021-01-01",
        "2021-02-01",
        "2021-03-01"
    ]
    value_list = [
        1632765.31317,
        1615776.58013,
        np.nan
    ]
    return pd.DataFrame(
        {'date': pd.to_datetime(date_list), 'value': value_list}
    )
